<!DOCTYPE html>
<html>
<head>
<title>WeatherBot</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="build/css/chat.css">
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700&amp;subset=latin-ext" rel="stylesheet"> 
</head>
<body>
	<header>
			<img src="build/img/logo.png" alt="Weatherbot logo">
			<h1>WeatherBot</h1>
	</header>

<main>
	<fieldset>
		<legend>Chat</legend>
		<div id="dialogue">
				<strong class='bot'>WeatherBot: </strong>Heja! Jestem botem pogodowym. Powiem ci wszystko o pogodzie! Spróbuj mnie spytać jaka jest pogoda w Poznaniu!</div>
		</div>
	</fieldset>
	<form onSubmit="return sendMessage()">
		<input type="text" name="message" id="message" placeholder="send a message" required>
		<button type="submit">Send!</button>
	</form>
</main>

<script type="text/javascript" src="build/js/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="build/js/datadumper.js"></script>
<script type="text/javascript" src="build/js/rivescript.js"></script>
<script type="text/javascript" src="build/js/bot.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qwest/4.4.2/qwest.min.js"></script>
<script type="text/javascript">

var logs = [];

function sendMessage (text) {
	var text = $("#message").val();
	text = removeDiactrics(text);

	$("#message").val("");
	$("#dialogue").append("<div class='chat_msg'><strong class='user'>Ty:</strong> " + text + "</div>");

	try {

		rs.replyAsync("soandso", text, this).then(function(reply) {
			$("#dialogue").append("<div class='chat_msg'><strong class='bot'>WeatherBot: </strong>" + reply + "</div>");

		    $('#dialogue').scrollTop($('#dialogue')[0].scrollHeight);
			logs.append({log:{user:text,bot:reply}})
	
			
		});

			
	} catch(e) {
		console.log(e);
	}



	return false;
}

function escapeHtml(text) {
	return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}



function savelogs(log) {
			console.log(log);
 		qwest.post("http://www.mieszkowrzeszczynski.pl/bot/log.php", {data:log}, {
            cache: true
        })
        .then(function(xhr, response) {
       		console.log("send a log");
            
        })
        .catch(function(e, xhr, response) {
            console.log("POST Error:" + e);
        });
	    
}
window.addEventListener('beforeunload', function(){
	savelogs(logs)
});

</script>

</body>
</html>
